# Cargar librerías necesarias
library(tseries)     # Para la prueba de Dickey-Fuller
library(forecast)    # Para modelos y gráficos ACF/PACF
library(ggplot2)     # Para visualización
library(ggfortify)   # Para gráficos de series temporales
library(TSA)         # Para análisis de series temporales

# Cargar el dataset
data("nottem")

# Inspeccionar la estructura del dataset
print(class(nottem))
print(summary(nottem))

# Graficar la serie temporal
plot(nottem, main = "Temperaturas Mensuales en Nottingham (1920-1939)",
     xlab = "Año", ylab = "Temperatura", col = "blue")

# Descomposición de la serie temporal
decomposed_nottem <- decompose(nottem, type = "multiplicative")
plot(decomposed_nottem)

# Análisis de estacionariedad con gráficos ACF y PACF
acf(nottem, main = "Autocorrelación de la Serie")
pacf(nottem, main = "Autocorrelación Parcial de la Serie")

# Prueba de Dickey-Fuller para verificar estacionariedad
adf_test <- adf.test(nottem)
print(adf_test)

# Si la serie no es estacionaria, aplicar diferenciación
if (adf_test$p.value > 0.05) {
  diff_nottem <- diff(nottem, differences = 1)
  plot(diff_nottem, main = "Serie Temporal Diferenciada",
       xlab = "Año", ylab = "Diferencias de Temperatura", col = "red")
  
  # Verificar estacionariedad después de la diferenciación
  acf(diff_nottem, main = "ACF de la Serie Diferenciada")
  pacf(diff_nottem, main = "PACF de la Serie Diferenciada")
  print(adf.test(diff_nottem))
}

# Detección de valores atípicos con boxplot
boxplot(nottem, main = "Detección de Valores Atípicos",
        ylab = "Temperatura", col = "lightblue")

# Gráfico de series temporales con valores atípicos resaltados
outliers <- boxplot.stats(nottem)$out
dates <- time(nottem)[nottem %in% outliers]
plot(nottem, main = "Temperaturas con Valores Atípicos Destacados",
     xlab = "Año", ylab = "Temperatura", col = "blue")
points(dates, outliers, col = "red", pch = 19)

# Guardar el código como un script de R
writeLines(
  deparse(substitute({
    # Código del análisis
  })), "nottem_analysis.R")
